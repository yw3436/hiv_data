---
title: "HIV dataset"
author: Yuqi Wang
output: github_document
---

```{r}
library(tidyverse)
library(rvest)
library(httr)

knitr::opts_chunk$set(
  fig.width = 6,
  fig.asp = .6,
  out.width = "90%"
)

theme_set(theme_minimal() + theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d

set.seed(1)
```

## HIV data from NYC open data
```{r}
nyc_hiv = 
  GET("https://data.cityofnewyork.us/resource/fju2-rdad.csv",
      query = list("$limit" = 7000)) %>% 
  content("parsed")

nyc_hiv %>% 
  filter(year == 2013) %>% view()
```


```{r}
library(pdftools)
url = "https://www1.nyc.gov/assets/doh/downloads/pdf/ah/surveillance2013-table-all.pdf"

title =  pdf_text(url) %>% 
  .[[2]] %>% str_split(., "\n") %>% .[[1]] %>% 
  .[4]

data = pdf_text(url) %>% 
  .[[2]] %>% str_split(., "\n") %>% 
  as_tibble(.name_repair = make.names) %>% 
  mutate(category = str_sub(X, 0,75),
         total_hiv_diag_N = str_sub(X,76,85),
         total_hiv_diag_per = str_sub(X,86,94),
         without_aids_N = str_sub(X,95,104),
         without_aids_per = str_sub(X,105,115),
         concurrent_aids_N = str_sub(X,116,126),
         concurrent_aids_per = str_sub(X,127,137),
         aids_N = str_sub(X,138,149),
         aids_per = str_sub(X,150,161),
         plwha_N = str_sub(X,162,175),
         plwha_per = str_sub(X,176,185),
         death_N = str_sub(X,186,193),
         death_per = str_sub(X,194)
         ) %>% 
  select(-X) %>% 
  .[-c(1:10),] %>% 
  filter(row_number() <= n()-2) %>% 
  mutate_all(funs(str_replace(.,",", ""))) %>% 
  mutate_all(str_squish) %>% 
  mutate_at(vars(-category), as.numeric)

data = cbind(title, data)
data %>% view()

#data =  pdf_text(url) %>% 
#  .[[2]] %>% str_split(., "\n") %>% 
#  as_tibble(.name_repair = make.names)
#data[11,1] %>% pull(X)
#str_locate_all(data[11,1] %>% pull(X), "1,852")

```

```{r}

pdf_scrape = function(pdf, report_year){
  title = pdf %>% 
    str_split(., "\n") %>% .[[1]] %>% 
  .[4]
  
  year = report_year
  
  data = pdf %>% str_split(., "\n") %>% 
  as_tibble(.name_repair = make.names) %>% 
  mutate(category = str_sub(X, 0,75),
         total_hiv_diag_N = str_sub(X,76,85),
         total_hiv_diag_per = str_sub(X,86,94),
         without_aids_N = str_sub(X,95,104),
         without_aids_per = str_sub(X,105,115),
         concurrent_aids_N = str_sub(X,116,126),
         concurrent_aids_per = str_sub(X,127,137),
         aids_N = str_sub(X,138,149),
         aids_per = str_sub(X,150,161),
         plwha_N = str_sub(X,162,175),
         plwha_per = str_sub(X,176,185),
         death_N = str_sub(X,186,193),
         death_per = str_sub(X,194)
         ) %>% 
  select(-X) %>% 
  .[-c(1:10),] %>% 
  filter(row_number() <= n()-2) %>% 
  mutate_all(funs(str_replace(.,",", ""))) %>% 
  mutate_all(str_squish) %>% 
  mutate_at(vars(-category), as.numeric)
  
  cbind(year, title, data) %>% 
    as_tibble()

}

pdf =  pdf_text(url) 
list = map(.x = pdf[-1], ~pdf_scrape(.x, 2013)) 
clean = as.data.frame(do.call(rbind, list))
clean %>% view()
```



```{r}
clean %>% 
  as_tibble() %>% 
  filter(title %in% c("Table 1.1. New York City (All)")) %>% 
  na.omit(total_hiv_diag_N) %>% 
  filter(category != "Unknown") %>% 
  mutate(
    sex = case_when(
      category == "Male" ~ "Male",
      category == "Female" ~ "Female",
      category == "Transgener" ~ "Transgender",
      TRUE ~ "All"
    ),
    race = case_when(
      category == "Black" ~ "Black",
      category == "Latino/Hispanic" ~ "Latino/Hispanic",
      category == "White" ~ "White",
      category == "Asian/Pacific Islander" ~ "Asian/Pacific Islander",
      category == "Native American" ~ "Native American",
      category == "Multiracial" ~ "Multiracial",
      TRUE ~ "All"
    ),
    borough = case_when(
      category == "Bronx" ~ "Bronx",
      category == "Brooklyn" ~ "Brooklyn",
      category == "Manhattan" ~ "Manhattan",
      category == "Queens" ~ "Queens",
      category == "Staten Island" ~ "Staten Island",
      category == "Outside NYC" ~ "Outside NYC",
      TRUE ~ "All"
    ),
    age_cat = case_when(
      category == "0-12" ~ "0-12",
      category == "13-19" ~ "20-29",
      category == "30-39" ~ "30-39",
      category == "40-49" ~ "40-49",
      category == "50-59" ~ "50-59",
      category == "60+" ~ "60+",
      TRUE ~ "All"
    )
  ) %>% 
  relocate(borough, sex, race) %>%
  select(-category) %>%
  head(23) %>% view()
    



 mutate(day_cat = case_when(
      day %in% c("Monday", "Tuesday", "Wednesday", "Thursday", "Friday") ~ "weekday",
      day %in% c("Saturday", "Sunday") ~ "weekend",
      TRUE ~ ""),
```



, 
                      "Table 1.5.1. Bronx, males (includes transgender men)",
                      "Table 1.5.2. Bronx, females (includes transgender women)",
                      "Table 1.5.3. Brooklyn, males (includes transgender men)",
                      "Table 1.5.4. Brooklyn, females (includes transgender women)",
                      "Table 1.5.5. Manhattan, males (includes transgender men)",
                      "Table 1.5.6. Manhattan, females (includes transgender women)",
                      "Table 1.5.7. Queens, males (includes transgender men)",
                      "Table 1.5.8. Queens, females (includes transgender women)",
                      "Table 1.5.9. Staten Island, males (includes transgender men)",
                      "Table 1.5.10. Staten Island, females (includes transgender women)"
